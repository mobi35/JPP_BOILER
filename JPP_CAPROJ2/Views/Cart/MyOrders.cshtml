@model IEnumerable<MyOrdersViewModel>
@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor
@{
    ViewData["Title"] = "MyOrders";
    Layout = "~/Views/Shared/Client.cshtml";
}


<section id="main-content">
    <div class="wrapper">

        <h3><i class="fa fa-angle-right"></i>My Orders</h3>
        <!-- BASIC FORM ELELEMNTS -->
        <div class="row mt">
            <div class="col-lg-12">
                <div class="form-panel">

                    <table class="table table-striped table-bordered responsive no-wrap" style="width:100%" id="userList">
                        <thead>
                            <tr>

                                <th>Products</th>
                                <th>Payment</th>
                                <th>Payment Terms</th>
                                <th>Status</th>
                                <th>Delivery Date</th>
                                <th></th>
                                <th>Upload</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                foreach (var pVM in Model)
                                {
                                    <tr>

                                        <td>
                                            @{

                                                if (pVM.Orders.Count == 0)
                                                {
                                                    <p>Inspection Cost</p>
                                                }

                                                foreach (var order in pVM.Orders)
                                                {
                                                    <p>@order.ProductName  X  @order.Quantity</p>


                                                }


                                            }

                                        </td>
                                        <td>P @pVM.Transactions.TotalPrice.ToString("N")</td>
                                        <td>@pVM.Transactions.PaymentTerms  </td>
                                        <td>
                                            <span class="badge badge-pill"> @pVM.Transactions.PaymentStatus </span> @{ if (pVM.Transactions.ImageString == null && pVM.Transactions.PaymentTerms != "Service")
                                                {
                                                    <a asp-route-id="@pVM.Transactions.TransactionKey" class="btn-sm btn-danger" asp-action="CancelPayment" asp-controller="Cart">Cancel Payment</a>
                                                }
                                                if (pVM.Transactions.PaymentStatus == "On-going")
                                                {
                                                    <a asp-route-id="@pVM.Transactions.TransactionKey" class="btn-sm btn-primary" asp-action="AcceptService" asp-controller="Cart">Accept Service</a>
                                                    <a asp-route-id="@pVM.Transactions.TransactionKey" class="btn-sm btn-danger" asp-action="RejectService" asp-controller="Cart">Reject Service</a>
                                                }
                                            }
                                        </td>
                                        <td>
                                            @{

                                             

                                           

                                                if (pVM.Transactions.DeliveryDate == null)
                                                {
                                                    @Html.Raw("TBA");
                                                }
                                                else if (pVM.Transactions.DeliveryStatus != "Completed" && pVM.Transactions.DeliveryStatus != "Delivered" && HttpContextAccessor.HttpContext.Session.GetString("UserName") != pVM.Transactions.WhoCanModify)
                                                {
                                                    @pVM.Transactions.DeliveryDate.Value.ToString("D")<br />

                                                    <span class="badge badge-pill">@pVM.Transactions.DeliveryStatus</span><br /><br />

                                                    <p>Do you want to accept this delivery?</p>
                                                    if (pVM.Transactions.DeliveryDate != null)
                                                    {
                                                        <a asp-route-id="@pVM.Transactions.TransactionKey" class="btn-sm btn-primary" asp-action="AcceptDelivery" asp-controller="Cart">Accept</a>
                                                        <a asp-route-id="@pVM.Transactions.TransactionKey" class="btn-sm btn-danger" asp-action="RejectDelivery" asp-controller="Cart">Reject</a>
                                                    }
                                                    <br /><br />
                                                    <span style="color:gray;">or you can choose your preferred date</span>
                                                    <form method="post" asp-action="CustomerPreferredDate" asp-controller="Cart">
                                                        <input type="hidden" value="@pVM.Transactions.TransactionKey" name="id" />
                                                        <input class="form-control" type="date" id="dateTime" name="dateTime" />
                                                        <br />
                                                        <input class="btn btn-sm" type="submit" />
                                                    </form>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-pill">@pVM.Transactions.DeliveryStatus</span>
                                                    @pVM.Transactions.DeliveryDate.Value.ToString("D")

                                                    if (DateTime.Now >= pVM.Transactions.DeliveryDate)
                                                    {
                                                        <a class="btn btn-success" asp-action="DoneDelivery" asp-controller="Cart" asp-route-id="@pVM.Transactions.TransactionKey">Done Delivery</a>
                                                    }
                                                }


                                            }
                                        </td>
                                        <td>
                                            @{
                                                if (pVM.Transactions.PaymentStatus == "Completed")
                                                {
                                                    <a asp-action="Invoice" asp-controller="Cart" asp-route-id="@pVM.Transactions.TransactionKey">
                                                    </a>
                                                }
                                            }
                                        </td>

                                        <td>
                                            @{
                                                if (pVM.Transactions.ImageString == null  && pVM.Transactions.PaymentTerms != "Cash on delivery")
                                                {
                                                    <form method="post" enctype="multipart/form-data" asp-controller="Cart" asp-action="AddDepositSlip">
                                                        <input name="id" value="@pVM.Transactions.TransactionKey" type="hidden" />
                                                        <input name="imageFile" type="file" />
                                                        <input type="submit" />
                                                    </form>
                                                }

                                            }
                                        </td>

                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</section>
<br />
<br />
<br />
<br />


<script>

    var now = new Date();
    var otherDate = new Date();
    now.setDate(otherDate.getDate() + 2);

    var minDate = now.toISOString().substring(0, 10);

    $('#dateTime').prop('min', minDate);


    $(document).ready(function () {
        $('#userList').DataTable({

            responsive: true,
            lengthChange: false,
            "sScrollX": "100%",
            "scrollCollapse": true,
            dom: 'lBfrtip',
            buttons: [
                {
                    extend: 'print',

                    customize: function (win) {
                        $(win.document.body)
                            .css({ 'font-size': '10pt' })
                         .prepend(
                                        '<h1 id="header"></h1><img  style="margin-left:250px; height:150px; text-align:center; z-index:5000; width:150px; top:0; left:0;" src="https://i.ibb.co/kMCSXcL/jpp.jpg" />'
                                    );

                        $(win.document.body).find('table')
                            .addClass('compact')
                            .css('font-size', 'inherit');
                    }
                }, 'excelHtml5', {
                    extend: 'pdf',
                    download: 'open',
                }
            ]

        });
    });

</script>
<script src="~/DataTables-1.10.18/js/jquery.dataTables.js"></script>
<script src="~/DataTables-1.10.18/js/dataTables.buttons.min.js"></script>
<script src="~/DataTables-1.10.18/js/buttons.print.min.js"></script>

<script src="~/DataTables-1.10.18/js/pdfmake.min.js"></script>
<script src="~/DataTables-1.10.18/js/vfs_fonts.js"></script>
<script src="~/DataTables-1.10.18/js/buttons.html5.min.js"></script>
<script src="~/DataTables-1.10.18/js/jszip.min.js"></script>
<script src="~/DataTables-1.10.18/js/dataTables.responsive.min.js"></script>
<script src="~/DataTables-1.10.18/js/responsive.bootstrap4.min.js"></script>

<link href="~/DataTables-1.10.18/css/responsive.bootstrap4.min.css" rel="stylesheet" />
<link href="~/DataTables-1.10.18/css/dataTables.bootstrap4.min.css" rel="stylesheet" />
<link href="~/DataTables-1.10.18/css/button.css" rel="stylesheet" />
<script src="~/DataTables-1.10.18/js/dataTables.bootstrap4.js"></script>

